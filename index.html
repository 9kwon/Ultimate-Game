<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Ultimatum Game</title>
  <style>
    body { font-family: Arial; padding: 2em; max-width: 1000px; margin: auto; font-size: 1.25em; line-height: 1.8; }
    .hidden { display: none; }
    button {
      margin: 0.3em;
      padding: 0.7em 1.5em;
      font-size: 1em;
      min-width: 130px;
    }
    #offerText { font-size: 1.4em; }
    #result { margin-top: 2em; font-weight: bold; font-size: 1.3em; }
    input[type=number], input[type=text] {
      width: 120px;
      font-size: 1.3em;
      padding: 1em;
    }
  </style>
</head>
<body>
  <h1>10만원 나눠 갖기</h1>

  <div id="intro">
    <img src="2000.png" alt="Ultimatum Game Illustration" style="max-width: 30%; height: auto; margin-bottom: 1em; display: block;">
    <p>당신은 협상 거래 테이블에 앉아 총 30회의 협상을 진행하게 됩니다.<br>
	매 거래마다 당신은 처음 보는 사람과 10만원을 나눠 가져야 합니다. <br>
	누군가는 너그럽고, 누군가는 욕심이 많습니다. 어떤 거래는 공정하고, 어떤 거래는 기분이 상할 수도 있죠. <br>
	<br>
	이 협상의 규칙은 한 사람은 비율을 제시하고, 다른 사람이 반드시 수락해야 계약이 성사된다는 것입니다. <br>
	즉, 상대가 당신에게 10만원 중 8만원을 갖고 2만원을 제시했을 때, <br>
	당신이 수락하면 계약은 성사되어 당신은 2만원, 상대는 8만원을 가집니다. <br>
	하지만 2만원이 너무 적다고 생각하여 거절한다면, 둘 다 돈을 받지 못합니다. <br>
	<br>
	이어지는 게임에서 당신은 비율을 제시할 수도 있고, 상대의 제안을 선택할 수도 있습니다. <br>
	당신은 어떤 선택을 하시겠습니까?</p>
    <button onclick="startGame()">시작</button>
  </div>

  <div id="proposer" class="hidden">
    <p>당신이 상대에게 제안합니다.</p>
    <label>0~100,000원 중에서 얼마를 상대에게 제시하겠습니까?</label><br>
    <input type="number" id="offerInput" min="0" max="100000" step="5000" value="50000">
    <br><button onclick="submitOffer()">제안하기</button>
  </div>

  <div id="responder" class="hidden">
    <p id="offerText"></p>
    <button onclick="respond('accept')">수락</button>
    <button onclick="respond('reject')">거절</button>
  </div>

  <div id="result" class="hidden"></div>
  <br><br><br>

  <div id="emotionSection" class="hidden">
    <p>지금 기분은 어땠나요?</p>
    <div id="emotionButtons">
      <button onclick="submitEmotion('기쁨')">😊 기쁨</button>
      <button onclick="submitEmotion('다행스러움')">😌 다행스러움</button>
      <button onclick="submitEmotion('무감정/잘 모르겠음')">😐 무감정/잘 모르겠음</button>
      <button onclick="submitEmotion('실망')">☹️ 실망</button>
      <button onclick="submitEmotion('화남')">😠 화남</button>
    </div>
  </div>

  <div id="end" class="hidden">
    <p>참여해 주셔서 감사합니다!</p>
    <p>이메일 ID와 전화번호 뒷자리 4자리를 입력해 주세요.</p>
    <input type="text" id="userEmail" placeholder="이메일 ID (예: example)" />
    <input type="text" id="userPhone" placeholder="전화번호 뒷자리 (예: 1234)" />
    <br><br>
    <button onclick="uploadToAirtable()">Airtable로 저장</button>
  </div>

  <script>
    const totalAmount = 100000;
    const BASE_ID = 'appcHpbgUBRzxdwZY';
    const TABLE_NAME = 'Results';
    const AIRTABLE_TOKEN = 'pat1bozMDIIWr8XYA';

    const roles = Array(12).fill('proposer').concat(Array(18).fill('responder'));
    shuffle(roles);

    const rounds = roles.map(role => {
      if (role === 'proposer') {
        return { role, aiType: randomAI() };
      } else {
        const frameType = Math.random() < 0.5 ? 'direct' : 'indirect';
        if (frameType === 'direct') {
          const share = [10000, 20000, 30000, 40000, 50000][Math.floor(Math.random() * 5)];
          return { role, type: 'direct', share, frameType };
        } else {
          const proposerPct = [60, 70, 80, 90][Math.floor(Math.random() * 4)];
          return { role, type: 'indirect', proposerPct, frameType };
        }
      }
    });

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function randomAI() {
      return ['무난이', '엄격이'][Math.floor(Math.random() * 2)];
    }

    let current = 0;
    let data = [];
    let trialStart;
    let currentTrialData = null;
    let aiMemory = {};

    function startGame() {
      document.getElementById('intro').classList.add('hidden');
      nextRound();
    }

    function nextRound() {
      if (current >= rounds.length) return showEnd();
      const round = rounds[current];
      trialStart = Date.now();

      if (round.role === 'proposer') {
        document.getElementById('proposer').classList.remove('hidden');
      } else {
        document.getElementById('responder').classList.remove('hidden');
        const offerText = document.getElementById('offerText');
        if (round.type === 'direct') {
          const proposerShare = totalAmount - round.share;
          offerText.textContent = `상대가 당신에게 ${round.share.toLocaleString()}원을 제시했습니다.`;
          round.offer = round.share;
        } else {
          const proposerShare = round.proposerPct / 100 * totalAmount;
          const responderShare = totalAmount - proposerShare;
          offerText.textContent = `상대가 자신이 ${proposerShare.toLocaleString()}원을 갖겠다고 제시했습니다.`;
          round.offer = responderShare;
        }
      }
    }

    function submitOffer() {
      const offer = parseInt(document.getElementById('offerInput').value);
      const round = rounds[current];
      const ai = round.aiType;
      if (!aiMemory[ai]) aiMemory[ai] = [];
      aiMemory[ai].push(offer);

      let strategy = "첫 제안";
      let risk = "중간";
      const prev = aiMemory[ai].slice(-2)[0];
      if (prev !== undefined) {
        const diff = Math.abs(offer - prev);
        strategy = diff >= 10000 ? "탐색" : "활용";
      }

      if (offer >= 50000) risk = "매우 낮음";
      else if (offer >= 40000) risk = "낮음";
      else if (offer >= 20000) risk = "중간";
      else risk = "높음";

      const acceptProb = ai === '무난이'
        ? (offer >= 40000 ? 1 : offer >= 20000 ? 0.6 : 0.2)
        : (offer >= 50000 ? 1 : offer >= 30000 ? 0.5 : 0.1);
      const accepted = Math.random() < acceptProb;

      const proposerReward = accepted ? totalAmount - offer : 0;
      const responderReward = accepted ? offer : 0;

      document.getElementById('proposer').classList.add('hidden');
      document.getElementById('result').textContent = accepted
        ? `상대(${ai})가 당신의 제안을 수락했습니다. 당신: ${proposerReward.toLocaleString()} / 상대: ${responderReward.toLocaleString()}`
        : `상대(${ai})가 당신의 제안을 거절했습니다. 둘 다 돈을 받지 못합니다.`;

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('emotionSection').classList.remove('hidden');

      const rt = ((Date.now() - trialStart) / 1000).toFixed(2);
      currentTrialData = {
        trial: current + 1, role: 'proposer', offer, aiType: ai,
        accepted, proposerReward, responderReward, rt, strategy, riskAversion: risk
      };
    }

    function respond(choice) {
      const round = rounds[current];
      const rt = ((Date.now() - trialStart) / 1000).toFixed(2);
      const accepted = choice === 'accept';
      const responderReward = accepted ? round.offer : 0;
      const proposerReward = accepted ? totalAmount - round.offer : 0;

      document.getElementById('responder').classList.add('hidden');
      document.getElementById('result').textContent = accepted
        ? `거래가 성사되었습니다. 당신: ${responderReward.toLocaleString()} / 상대: ${proposerReward.toLocaleString()}`
        : `거래가 결렬되었습니다. 둘 다 돈을 받지 못합니다.`;
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('emotionSection').classList.remove('hidden');

      currentTrialData = {
        trial: current + 1, role: 'responder', offer: round.offer,
        response: choice, rt, responderReward, proposerReward,
        frameType: round.frameType
      };
    }

    function submitEmotion(emotion) {
      currentTrialData.emotion = emotion;
      data.push(currentTrialData);
      currentTrialData = null;
      current++;
      document.getElementById('emotionSection').classList.add('hidden');
      document.getElementById('result').classList.add('hidden');
      nextRound();
    }

    function showEnd() {
      document.getElementById('end').classList.remove('hidden');
    }

    function uploadToAirtable() {
      const email = document.getElementById('userEmail')?.value?.trim();
      const phone = document.getElementById('userPhone')?.value?.trim();
      if (!email || !phone) {
        alert("이메일과 전화번호 뒷자리를 입력해 주세요.");
        return;
      }

      const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;

      const records = data.map(row => ({
        fields: {
          ...row,
          emailID: email,
          phoneSuffix: phone
        }
      }));

      const chunkSize = 10;
      for (let i = 0; i < records.length; i += chunkSize) {
        const batch = records.slice(i, i + chunkSize);
        fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ records: batch })
        })
        .then(res => res.json())
        .then(res => console.log("저장됨:", res))
        .catch(err => alert("저장 실패: " + err));
      }

      alert("Airtable 저장 시도 완료!");
    }
  </script>
</body>
</html>
