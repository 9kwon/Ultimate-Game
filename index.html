<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Ultimatum Game</title>
  <style>
    body { font-family: Arial; padding: 2em; max-width: 1000px; margin: auto; font-size: 1.25em; line-height: 1.8; }
    .hidden { display: none; }
    button {
      margin: 0.3em;
      padding: 0.7em 1.5em;
      font-size: 1em;
      min-width: 130px;
    }
    #offerText { font-size: 1.4em; }
    #result { margin-top: 2em; font-weight: bold; font-size: 1.3em; }
    input[type=number], input[type=text] {
      width: 250px;
      font-size: 1.2em;
      padding: 0.5em;
      margin-top: 0.3em;
    }
  </style>
</head>
<body>
  <h1>10ë§Œì› ë‚˜ëˆ  ê°–ê¸°</h1>

  <div id="intro">
    <p>ë‹¹ì‹ ì€ í˜‘ìƒ ê±°ë˜ í…Œì´ë¸”ì— ì•‰ì•„ ì´ 30íšŒì˜ í˜‘ìƒì„ ì§„í–‰í•˜ê²Œ ë©ë‹ˆë‹¤.<br>
    ì œì•ˆ 12íšŒ, ìˆ˜ë½/ê±°ì ˆ 18íšŒë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.<br>
    ê°ì • ë° ì „ëµ ë°˜ì‘ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
    <button onclick="startGame()">ì‹œì‘</button>
  </div>

  <div id="proposer" class="hidden">
    <p>ë‹¹ì‹ ì´ ìƒëŒ€ì—ê²Œ ì œì•ˆí•©ë‹ˆë‹¤.</p>
    <label>0~100,000ì› ì¤‘ì—ì„œ ì–¼ë§ˆë¥¼ ìƒëŒ€ì—ê²Œ ì œì‹œí•˜ê² ìŠµë‹ˆê¹Œ?</label><br>
    <input type="number" id="offerInput" min="0" max="100000" step="5000" value="50000">
    <br><button onclick="submitOffer()">ì œì•ˆí•˜ê¸°</button>
  </div>

  <div id="responder" class="hidden">
    <p id="offerText"></p>
    <button onclick="respond('accept')">ìˆ˜ë½</button>
    <button onclick="respond('reject')">ê±°ì ˆ</button>
  </div>

  <div id="result" class="hidden"></div>

  <div id="emotionSection" class="hidden">
    <p>ì§€ê¸ˆ ê¸°ë¶„ì€ ì–´ë• ë‚˜ìš”?</p>
    <div id="emotionButtons">
      <button onclick="submitEmotion('ê¸°ì¨')">ğŸ˜Š ê¸°ì¨</button>
      <button onclick="submitEmotion('ë‹¤í–‰ìŠ¤ëŸ¬ì›€')">ğŸ˜Œ ë‹¤í–‰ìŠ¤ëŸ¬ì›€</button>
      <button onclick="submitEmotion('ë¬´ê°ì •/ì˜ ëª¨ë¥´ê² ìŒ')">ğŸ˜ ë¬´ê°ì •/ì˜ ëª¨ë¥´ê² ìŒ</button>
      <button onclick="submitEmotion('ì‹¤ë§')">â˜¹ï¸ ì‹¤ë§</button>
      <button onclick="submitEmotion('í™”ë‚¨')">ğŸ˜  í™”ë‚¨</button>
    </div>
  </div>

  <div id="end" class="hidden">
    <p>ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!</p>
    <input type="text" id="userEmail" placeholder="ì´ë©”ì¼ ID (ì˜ˆ: example)" /><br>
    <input type="text" id="userPhone" placeholder="ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ (ì˜ˆ: 1234)" /><br>
    <button onclick="submitToNetlify()">ê²°ê³¼ ì €ì¥</button>
  </div>

  <script>
    const totalAmount = 100000;
    const roles = Array(12).fill('proposer').concat(Array(18).fill('responder'));
    shuffle(roles);

    const rounds = roles.map(role => {
      if (role === 'proposer') return { role, aiType: randomAI() };
      const frameType = Math.random() < 0.5 ? 'direct' : 'indirect';
      if (frameType === 'direct') {
        const share = [10000, 20000, 30000, 40000, 50000][Math.floor(Math.random() * 5)];
        return { role, type: 'direct', share, frameType };
      } else {
        const proposerPct = [60, 70, 80, 90][Math.floor(Math.random() * 4)];
        return { role, type: 'indirect', proposerPct, frameType };
      }
    });

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function randomAI() {
      return ['ë¬´ë‚œì´', 'ì—„ê²©ì´'][Math.floor(Math.random() * 2)];
    }

    let current = 0;
    let data = [];
    let trialStart;
    let currentTrialData = null;
    let aiMemory = {};

    function startGame() {
      document.getElementById('intro').classList.add('hidden');
      nextRound();
    }

    function nextRound() {
      if (current >= rounds.length) return showEnd();

      const round = rounds[current];
      trialStart = Date.now();

      if (round.role === 'proposer') {
        document.getElementById('proposer').classList.remove('hidden');
      } else {
        document.getElementById('responder').classList.remove('hidden');
        const offerText = document.getElementById('offerText');
        if (round.type === 'direct') {
          const proposerShare = totalAmount - round.share;
          offerText.textContent = `ìƒëŒ€ê°€ ë‹¹ì‹ ì—ê²Œ ${round.share.toLocaleString()}ì›ì„ ì œì‹œí–ˆìŠµë‹ˆë‹¤.`;
          round.offer = round.share;
        } else {
          const proposerShare = round.proposerPct / 100 * totalAmount;
          const responderShare = totalAmount - proposerShare;
          offerText.textContent = `ìƒëŒ€ê°€ ìì‹ ì´ ${proposerShare.toLocaleString()}ì›ì„ ê°–ê² ë‹¤ê³  ì œì‹œí–ˆìŠµë‹ˆë‹¤.`;
          round.offer = responderShare;
        }
      }
    }

    function submitOffer() {
      const offer = parseInt(document.getElementById('offerInput').value);
      const round = rounds[current];
      const ai = round.aiType;
      if (!aiMemory[ai]) aiMemory[ai] = [];
      aiMemory[ai].push(offer);

      let strategy = "ì²« ì œì•ˆ";
      let risk = "ì¤‘ê°„";
      const prev = aiMemory[ai].slice(-2)[0];
      if (prev !== undefined) {
        const diff = Math.abs(offer - prev);
        strategy = diff >= 10000 ? "íƒìƒ‰" : "í™œìš©";
      }
      if (offer >= 50000) risk = "ë§¤ìš° ë‚®ìŒ";
      else if (offer >= 40000) risk = "ë‚®ìŒ";
      else if (offer >= 20000) risk = "ì¤‘ê°„";
      else risk = "ë†’ìŒ";

      const acceptProb = ai === 'ë¬´ë‚œì´'
        ? (offer >= 40000 ? 1 : offer >= 20000 ? 0.6 : 0.2)
        : (offer >= 50000 ? 1 : offer >= 30000 ? 0.5 : 0.1);
      const accepted = Math.random() < acceptProb;

      const proposerReward = accepted ? totalAmount - offer : 0;
      const responderReward = accepted ? offer : 0;

      document.getElementById('proposer').classList.add('hidden');
      document.getElementById('result').textContent = accepted
        ? `ìƒëŒ€(${ai})ê°€ ë‹¹ì‹ ì˜ ì œì•ˆì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤. ë‹¹ì‹ : ${proposerReward.toLocaleString()} / ìƒëŒ€: ${responderReward.toLocaleString()}`
        : `ìƒëŒ€(${ai})ê°€ ë‹¹ì‹ ì˜ ì œì•ˆì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤. ë‘˜ ë‹¤ ëˆì„ ë°›ì§€ ëª»í•©ë‹ˆë‹¤.`;

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('emotionSection').classList.remove('hidden');

      const rt = ((Date.now() - trialStart) / 1000).toFixed(2);
      currentTrialData = {
        trial: current + 1, role: 'proposer', offer, aiType: ai,
        accepted, proposerReward, responderReward, rt, strategy, riskAversion: risk
      };
    }

    function respond(choice) {
      const round = rounds[current];
      const rt = ((Date.now() - trialStart) / 1000).toFixed(2);
      const accepted = choice === 'accept';
      const responderReward = accepted ? round.offer : 0;
      const proposerReward = accepted ? totalAmount - round.offer : 0;

      document.getElementById('responder').classList.add('hidden');
      document.getElementById('result').textContent = accepted
        ? `ê±°ë˜ê°€ ì„±ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¹ì‹ : ${responderReward.toLocaleString()} / ìƒëŒ€: ${proposerReward.toLocaleString()}`
        : `ê±°ë˜ê°€ ê²°ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‘˜ ë‹¤ ëˆì„ ë°›ì§€ ëª»í•©ë‹ˆë‹¤.`;
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('emotionSection').classList.remove('hidden');

      currentTrialData = {
        trial: current + 1, role: 'responder', offer: round.offer,
        response: choice, rt, responderReward, proposerReward,
        frameType: round.frameType
      };
    }

    function submitEmotion(emotion) {
      currentTrialData.emotion = emotion;
      data.push(currentTrialData);
      currentTrialData = null;
      current++;
      document.getElementById('emotionSection').classList.add('hidden');
      document.getElementById('result').classList.add('hidden');
      nextRound();
    }

    function showEnd() {
      document.getElementById('end').classList.remove('hidden');
    }

    function submitToNetlify() {
      const email = document.getElementById('userEmail').value.trim();
      const phone = document.getElementById('userPhone').value.trim();
      if (!email || !phone) {
        alert("ì´ë©”ì¼ê³¼ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }
      data.forEach(d => {
        d.emailID = email;
        d.phoneSuffix = phone;
      });

      fetch('/.netlify/functions/save-results', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.ok ? res.text() : Promise.reject(res.statusText))
      .then(msg => alert("Netlify ì„œë²„ì— ì €ì¥ ì™„ë£Œ! âœ…"))
      .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
    }
  </script>
</body>
</html>
